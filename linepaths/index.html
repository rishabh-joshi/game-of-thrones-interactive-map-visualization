<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CARTO.js GoT Distance Calculator</title>
    <link rel="shortcut icon" href="egg.ico" />

    <!-- family fonts -->
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=MedievalSharp" rel="stylesheet">

    <!-- leaflet + jquery -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- chart.js -->
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.bundle.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>

    <!-- carto.js -->
    <script src="https://cdn.rawgit.com/CartoDB/cartodb.js/@4.0.0-alpha.28/carto.js"></script>

    <!-- jquery-ui -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="app.css">

    <script type="text/sql" id="labels-query">
      select * from locations
    </script>

    <script type="text/cartocss" id="labels-style">
      Map{
        buffer-size: 512;
      }

      #layer[type='City']{

      ::inner{
        marker-fill-opacity: 1;
        marker-fill:#fff;
        marker-line-width: 0.7;
        marker-line-opacity: 0.8;
        marker-placement: point;
        marker-type: ellipse;
        marker-width: 4;
        marker-line-color: fadeout(lighten(#bac9ad,12),70);
        marker-allow-overlap: true;
          [zoom>=5]{marker-width: 6;}
          [zoom>=6]{marker-width: 7;}
          [zoom>=7]{marker-width: 10;}
        
      }
          
      ::labels {
        text-name: [name];
        text-face-name: "Lato Bold Italic";
        text-size: 13;
        text-fill: #fff;
        text-halo-fill:fadeout(lighten(#bac9ad,12),70);
        text-halo-radius: 1.5;
        text-placement-type: simple;
        text-placements: "E,W,NW,NE,SE,8";
        text-dx:-7;
        text-dy:-4;
        text-character-spacing: 0;
          [zoom>=5]{text-size: 14;}
          [zoom>=6]{text-size: 15;}
          [zoom>=7]{text-size: 16;}
       }
      }
    </script>

    <script type="text/sql" id="lines-query">
      select 
        row_number() over() as cartodb_id, 
        st_makeline(the_geom order by cartodb_id asc) as the_geom, 
        st_transform(st_makeline(the_geom order by cartodb_id asc), 3857) as the_geom_webmercator,
        array_agg(distinct season) as seasons,
        st_length(st_makeline(the_geom order by cartodb_id asc)::geography)*0.138980150292748/1000 as distance,
        character,
        max(color) as color,
        max(house) as house
      from 
        episodes_locations 
      group by 
        character
    </script>

    <script type="text/cartocss" id="lines-style">
      #layer {
        line-width: 4;
        line-opacity: 0.5;
          [ house = "Stark" ] {
                      line-color: fadeout(lighten(#bac9ad,12),70);
                }
          [ house = "Lannister" ] {
                        line-color: fadeout(lighten(#DDCC77,12),70);
                }
          [ house = "Baelish" ] {
                        line-color: fadeout(lighten(#bac9ad,12),70);
                }
          [ house = "Greyjoy" ] {
                        line-color: fadeout(lighten(#DDCC77,12),70);
                }
          [ house = "Seaworth" ] {
                        line-color: fadeout(lighten(#bac9ad,12),70);
                }
          [ house = "Targaryen" ] {
                        line-color: fadeout(lighten(#332288,12),70);
                }
          [ house = "Tarly" ] {
                        line-color: fadeout(lighten(#117733,12),70);
                }
          [ house = "Tarth" ] {
                        line-color: fadeout(lighten(#CC6677,12),70);
                }
        
        ::inner{   
          line-width: 2;
          line-opacity: 1;
          line-dasharray: 10, 4;
          line-color: [color];
        }
      }
    </script> 

    <script type="text/sql" id="points-query">
      select 
        row_number() over() as cartodb_id, 
        st_endpoint(st_makeline(the_geom order by cartodb_id asc)) as the_geom, 
        st_endpoint(st_transform(st_makeline(the_geom order by cartodb_id asc), 3857)) as the_geom_webmercator,
        array_agg(distinct season) as seasons,
        character,
        max(color) as color,
        max(house) as house
      from 
        episodes_locations 
      group by 
        character
    </script>

    <script type="text/cartocss" id="points-style">
      #layer{
        marker-width: 20;
        marker-allow-overlap: true;
        marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/20171129092439Group_xmflvz.png');
        
        [character = 'Daenerys']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909220702_daenerys.png');
        }
        [character = 'Jon']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909223403_jonsnow.png');
        }
        [character = 'Tyrion']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909225804_tyrion.png');
        }
        [character = 'Jaime']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909245705_jaime.png');
        }
        [character = 'Arya']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909251508_arya.png');
        }
        [character = 'Sam']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909252409_sam.png');
        }
        [character = 'Sansa']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909261616_sansa.png');
        }
        [character = 'Cersei']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909253711_cersei.png');
        }
        [character = 'Robb']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909255816_robb.png');
        }
        [character = 'Littlefinger']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909262717_petyr.png');
        }
        [character = 'Brienne']{
          marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/ramirocartodb/assets/2017112909263720_brienne.png');
        }
      }
    </script>       
    
  </head>
  <body>

    <div id="map"></div>

    <div id="sidebar">
      <div class="legend">
        <h6 class="title">Game of Thrones Distance Calculator</h6>
        <p class="text">Is winter coming at the speed of light? Is Littlefinger using teleportation? Are ravens faster than dragons? In order to answer this questions, check the GoT Distance Calculator built with CARTO.js. <strong>Discover which character has traveled the most depending on the season.</strong></p>
      </div>

      <div id="season-selector"></div>
      <div id="season-labels"></div>

      <canvas id="chart" width="400" height="400"></canvas>

    </div>

    <script type="text/javascript" src="app.js"></script>

  </body>
</html>